# Plan: Web Terminal Interface for opencode-pty

## Overview

Add a web-based terminal interface to view and control PTY sessions from a browser using xterm.js and Bun's native WebSocket support.

## Architecture

```
┌─────────────────────────────────────────────────────────┐
│  Browser: Dashboard (session list) + Terminal (xterm.js) │
└─────────────────────────┬───────────────────────────────┘
                          │ WebSocket + HTTP
                          ▼
┌─────────────────────────────────────────────────────────┐
│  Bun.serve() - HTTP routes + WebSocket upgrade           │
│  └── SessionEmitter (new) ← broadcasts PTY output        │
│       └── PTYManager (modified) ← existing session mgmt  │
└─────────────────────────────────────────────────────────┘
```

**Data Flow:**
- Input: Browser → WebSocket → `manager.write()` → PTY stdin
- Output: PTY stdout → `onData` → buffer + emitter → WebSocket → xterm.js

## Files to Create

| File | Purpose |
|------|---------|
| `src/plugin/pty/emitter.ts` | Event subscription for real-time output |
| `src/plugin/pty/web/server.ts` | Bun HTTP/WS server using `Bun.serve()` |
| `src/plugin/pty/web/static/index.html` | Dashboard + terminal UI (single page) |
| `src/plugin/pty/tools/web.ts` | `pty_web` tool to start/stop server |
| `src/plugin/pty/tools/web.txt` | Tool description |

## Files to Modify

| File | Changes |
|------|---------|
| `src/plugin/pty/manager.ts` | Hook `onData`/`onExit` into emitter |
| `src/plugin/pty/types.ts` | Add WebSocket message types |
| `src/plugin.ts` | Register `pty_web` tool |

## API Design

### HTTP Endpoints

| Method | Path | Response |
|--------|------|----------|
| `GET /` | Dashboard HTML | `index.html` |
| `GET /api/sessions` | Session list | `PTYSessionInfo[]` |
| `GET /api/sessions/:id` | Session detail | `PTYSessionInfo` |

### WebSocket Protocol

**Connect:** `ws://localhost:7681/ws?session=pty_xxxx`

**Client → Server:**
```json
{ "type": "input", "data": "ls -la\n" }
{ "type": "resize", "cols": 120, "rows": 40 }
{ "type": "history" }
```

**Server → Client:**
```json
{ "type": "output", "data": "..." }
{ "type": "state", "status": "exited", "exitCode": 0 }
{ "type": "history", "lines": [...], "totalLines": 500 }
```

## Implementation Phases

### Phase 1: Event Emitter (~2 hrs)
- Create `emitter.ts` with typed subscription system
- Modify `manager.ts` to emit on `onData`/`onExit`
- Write unit tests

### Phase 2: WebSocket Server (~3 hrs)
- Create `server.ts` with `Bun.serve()`
- Handle WS upgrade for `/ws?session=xxx`
- Wire subscriptions: WS open → subscribe, close → unsubscribe
- Handle input messages → `manager.write()`

### Phase 3: HTTP API (~2 hrs)
- Add REST routes (`/api/sessions`, etc.)
- Serve static files
- Create `pty_web` tool

### Phase 4: Frontend (~4 hrs)
- Single-page dashboard with session list
- xterm.js terminal (CDN import)
- Session switching, real-time output, input handling

### Phase 5: Polish (~2 hrs)
- Terminal resize support
- Handle session exit gracefully
- Reconnect logic

**Total: ~13 hours**

## Dependencies

**Frontend (CDN - no install needed):**
- `@xterm/xterm` - terminal emulator
- `@xterm/addon-fit` - auto-resize

**Backend:** None - Bun has native WebSocket support

## Key Code Snippets

### Emitter Pattern
```typescript
// src/plugin/pty/emitter.ts
class SessionEmitter {
  private listeners = new Map<string, Set<(data: string) => void>>();
  
  subscribe(id: string, cb: (data: string) => void): () => void {
    if (!this.listeners.has(id)) this.listeners.set(id, new Set());
    this.listeners.get(id)!.add(cb);
    return () => this.listeners.get(id)?.delete(cb);
  }
  
  emit(id: string, data: string) {
    this.listeners.get(id)?.forEach(cb => cb(data));
  }
}
export const emitter = new SessionEmitter();
```

### Manager Integration
```typescript
// In manager.ts spawn():
ptyProcess.onData((data: string) => {
  buffer.append(data);
  emitter.emit(id, data);  // NEW
});
```

### Server Skeleton
```typescript
// src/plugin/pty/web/server.ts
export function startWebServer(port = 7681) {
  return Bun.serve({
    port,
    fetch(req, server) {
      const url = new URL(req.url);
      if (url.pathname === "/ws") {
        const sessionId = url.searchParams.get("session");
        server.upgrade(req, { data: { sessionId } });
        return;
      }
      // HTTP routes...
    },
    websocket: {
      open(ws) {
        const { sessionId } = ws.data;
        const unsub = emitter.subscribe(sessionId, data => 
          ws.send(JSON.stringify({ type: "output", data }))
        );
        ws.data.unsub = unsub;
      },
      message(ws, msg) {
        const { type, data } = JSON.parse(msg);
        if (type === "input") manager.write(ws.data.sessionId, data);
      },
      close(ws) { ws.data.unsub?.(); }
    }
  });
}
```

## Verification

1. **Start a PTY session:** `pty_spawn` with `npm run dev` or similar
2. **Start web server:** `pty_web start` (or `pty_web` tool)
3. **Open browser:** `http://localhost:7681`
4. **Verify dashboard:** Should show active session(s)
5. **Click session:** Should see real-time output in xterm.js
6. **Type commands:** Input should reach the PTY
7. **Verify existing tools:** `pty_read`/`pty_write` should still work

## Security

- **Default:** Bind to `localhost` only (no external access)
- **Future:** Optional token auth via `?token=xxx` query param
